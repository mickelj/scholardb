const _ = require("underscore");
const request = require("request");
const	parser = require('libxml-to-js');

module.exports = function(txt, callback) {
	request.post('http://freecite.library.brown.edu/citations/create', {
		headers: { accept: "text/xml"	},
		form: {	citation: txt	}
	},
	function (err, response, body) {
		if (err) callback(err);
		parser(body, function (error, result) {
	    if (error) callback(error);
			if (result.citation['@'].valid !== 'true') callback();
			var citation = result.citation;
			delete citation.raw_string;
			delete citation['@'];
			if (_.isArray(citation.authors.author)) {
				citation.authors = _.map(citation.authors.author, function(author) {
					return author['#'];
				});
			} else {
				citation.authors = [citation.authors.author];
			}
			callback(null, citation);
		});
	});
}
